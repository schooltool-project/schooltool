#!/usr/bin/make -f

# If you change the seed, you will have to recreate ttconfig.data as well.
datagen_seed = schooltool-m4

# This number and the dependencies should be the only thing needed to change
# the python version
PYTHON_VERSION=2.3
PYTHON=python$(PYTHON_VERSION)

# Server Packages
package=schoolbell
module=zope3.1-pyhton2.3-schoolbell
libpkg=libschoolbell

# Executable Scripts
scripts=debian/schoolbell.py

#
# Rules to build tree
#

.PHONY: build
build: build-stamp

debian/import-sampleschool.py.template: debian/import-sampleschool.head
	(cat $< && sed -ne '/^# -- Do not remove this line --$$/,$$p' \
	    import-sampleschool.py) > $@

$(scripts): %: %.template
	cat $< | sed s/@PYTHON@/$(PYTHON)/ > $@

build-stamp:
	dh_testdir
	$(MAKE) PYTHON=$(PYTHON) PYTHONDIR=/usr/bin/$(PYTHON)
	touch build-stamp

.PHONY: clean
clean::
	dh_testdir
	dh_testroot
	-$(MAKE) realclean
	rm -f debian/import-sampleschool.py
	rm -f debian/schooltool.py
	rm -f debian/schoolbell.py
	rm -f debian/schooltool-client.py
	rm -f debian/import-sampleschool.py.template
	rm -f install-arch-stamp
	rm -f install-indep-stamp
	dh_clean
	debconf-updatepo

.PHONY:install
install: install-arch install-indep

.PHONY: install-indep
install-indep: install-indep-stamp
install-indep-stamp: $(scripts)
	dh_testdir
	dh_testroot
	dh_clean -k -i
	dh_installdirs -i

	################## python2.3-schoolbell ################
	cd src && \
	find \( -name tests -o -name ftests -o -name clients \) -prune -o \
	     \( -name '*.py'  -o -name '*.pt'  -o -name '*.mo'  -o \
	        -name '*.xml' -o -name '*.rng' -o -name '*.png' -o \
		-name '*.xpm' -o -name '*.css' -o -name '*.js' \) \
	     -exec install -m 644 -D -p {} \
		../debian/$(module)/usr/lib/$(module)/{} \;
	cd Zope3/src && \
	find \( -name tests -o -name ftests -o -name clients \) -prune -o \
	     \( -name '*.py'  -o -name '*.pt'  -o -name '*.mo'  -o \
	        -name '*.xml' -o -name '*.rng' -o -name '*.png' -o \
		-name '*.xpm' -o -name '*.css' -o -name '*.js' \) \
	     -exec install -m 644 -D -p {} \
		../../debian/$(module)/usr/lib/$(module)/{} \;
	rm -f debian/$(module)/usr/lib/$(module)/trace.py
	
	################## schoolbell ########################
	# executables
	install -m 755 -D -p debian/$(package).py \
		debian/$(package)/usr/bin/$(package); \
	# configuration
	install -m 644 -D -p debian/$(package).logrotate \
		debian/$(package)/etc/logrotate.d/$(package)
	install -m 644 -D -p debian/ssl-cert.cnf \
	    debian/$(package)/etc/$(package)/ssl-cert.cnf
	install -m 644 -D -p debian/$(package).conf.default \
	    debian/$(package)/usr/share/$(package)/$(package).conf.default

	touch install-indep-stamp

.PHONY: install-arch
install-arch: install-arch-stamp
install-arch-stamp: build
	dh_testdir
	dh_testroot
	dh_clean -k -s
	dh_installdirs -s

	# what about ZConfig/doc/schema.dtd? zconfig.pdf?

	################ libschoolbell ###################
	# make server library package (Only zope3 has python extensions)
	# arch-dep files
	cd Zope3/src && \
	find \( -name tests -o -name ftests -o -name clients \) -prune -o \
		-name '*.so'  \
		$(archdep)\
	     -exec install -m 644 -D -p {} \
		../../debian/$(libpkg)/usr/lib/$(package)/{} \;

	touch install-arch-stamp

.PHONY: binary-common
binary-common:
	dh_testdir
	dh_testroot
	dh_installdocs
	dh_installinit
	dh_installexamples
	dh_installman
	dh_installdebconf
	dh_installchangelogs
	dh_strip
	dh_compress
	dh_fixperms
	dh_python -V $(PYTHON_VERSION)
	dh_makeshlibs
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

.PHONY: binary-indep
binary-indep: build install-indep
	$(MAKE) -f debian/rules DH_OPTIONS=-i binary-common

.PHONY: binary-arch
binary-arch: build install-arch
	$(MAKE) -f debian/rules DH_OPTIONS=-a binary-common

.PHONY: binary
binary: binary-arch binary-indep
