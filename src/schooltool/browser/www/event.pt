<html metal:use-macro="view/macros/page" i18n:domain="schooltool">
<head>
  <title metal:fill-slot="title" tal:content="view/page_title">title</title>

  <script type="text/javascript" metal:fill-slot="extrahead">
    function location_changed() {
        var location = document.getElementById('location');
        var location_other = document.getElementById('location_other');
        location_other.disabled = (location.value != '');
    }
    function recurrence_changed() {
        var recurrence = document.getElementById('recurrence');
        var recurrence_box = document.getElementById('recurrence_box');
        var update_box = document.getElementById('update_box');
        if (recurrence.checked) {
            recurrence_box.style.display = 'block';
            update_box.style.display = 'block';
        } else {
            recurrence_box.style.display = 'none';
            update_box.style.display = 'none';
        }
    }
    function recurrence_type_changed() {
        var recurrence = document.getElementById('recurrence_type');
        var weekly_row = document.getElementById('weekly_row');
        var monthly_box = document.getElementById('monthly_box');
        if (recurrence.value == 'weekly') {
            weekly_row.style.display = 'block';
            monthly_box.style.display = 'none';
        } else if (recurrence.value == 'monthly') {
            weekly_row.style.display = 'none';
            monthly_box.style.display = 'block';
        } else {
            weekly_row.style.display = 'none';
            monthly_box.style.display = 'none';
        }
    }
    function range_changed() {
        var range_c = document.getElementById('range_c');
        var range_u = document.getElementById('range_u');
        var count = document.getElementById('count');
        var until = document.getElementById('until');
        count.disabled = !range_c.checked;
        until.disabled = !range_u.checked;
    }
    function onloadhook() {
        location_changed();
        var location = document.getElementById('location');
        addEvent(location, "change", location_changed);
        addEvent(location, "keyup", location_changed);

        if (!document.getElementById('recurrence_box'))
            return;

        recurrence_changed();
        var recurrence = document.getElementById('recurrence');
        addEvent(recurrence, "click", recurrence_changed);

        range_changed();
        var range_c = document.getElementById('range_c');
        var range_u = document.getElementById('range_u');
        var range_f = document.getElementById('range_f');
        addEvent(range_c, "click", range_changed);
        addEvent(range_u, "click", range_changed);
        addEvent(range_f, "click", range_changed);

        recurrence_type_changed();
        var recurrence_type = document.getElementById('recurrence_type');
        addEvent(recurrence_type, "change", recurrence_type_changed);
        addEvent(recurrence_type, "keyup", recurrence_type_changed);

        /* Hide the help paragraphs if JavaScript is working */
        var weekly_par = document.getElementById('weekly_par');
        var monthly_par = document.getElementById('monthly_par');
        monthly_par.style.display = 'none';
        weekly_par.style.display = 'none';
    }
    function addEvent(obj, event, handler) {
      if (obj.addEventListener) {
          obj.addEventListener(event, handler, false);
      } else if (obj.attachEvent) {
          obj.attachEvent("on" + event, handler);
      }
    }
    addEvent(window, "load", onloadhook);
  </script>
</head>
<body>

<h1 metal:fill-slot="h1" tal:content="view/page_title" />

<metal:block metal:fill-slot="content">

<div tal:condition="view/error" class="error" tal:content="view/error" />
<tal:block condition="not:view/error">

  <p tal:condition="view/tt_event">
    You are trying to alter a timetable event.  An exception for this event
    will be generated in the timetable.
  </p>

  <form method="POST" tal:attributes="action request/path">

    <input tal:condition="request/args/event_id|nothing"
           type="hidden" name="event_id"
           tal:attributes="value view/event_id" />

    <div class="row" tal:replace="structure view/title_widget" />
    <div class="row" tal:replace="structure view/date_widget" />
    <div class="row" tal:replace="structure view/time_widget" />
    <div class="row" tal:replace="structure view/location_widget" />
    <div class="row" tal:replace="structure view/other_location_widget" />
    <div class="row" tal:replace="structure view/duration_widget" />
    <div class="row" tal:replace="structure view/privacy_widget" />

<tal:block condition="not: view/tt_event">
    <div class="row" tal:replace="structure view/recurrence_widget" />
  <div id="recurrence_box">
    <div class="buttons" id="update_box">
      <input class="button" name="UPDATE" type="submit" value="Update form"
             i18n:attributes="value" />
    </div>
    <!-- Repeat every [count] [freq [v]] -->
    <div class="row">
      <label for="interval">Repeat every</label>
      <input type="text" name="interval" id="interval" size="3"
             tal:attributes="value view/interval_widget/raw_value" />
      <select name="recurrence_type" id="recurrence_type">
        <option tal:replace="structure
                             view/recurrence_type_widget/_options_html"/>
      </select>
      <div tal:replace="structure view/interval_widget/_error_html"/>
    </div>
    <!-- weekly box -->
    <fieldset id="weekly_row">
      <legend>Weekly</legend>
      <p id="weekly_par">This section only applies when the weekly
      recurrence is selected.</p>
      <span tal:repeat="weekday view/weekdays" >
        <input type="checkbox" name="weekdays"
               tal:define="day view/date_widget/value"
               tal:attributes="
                   id string:weekday_${weekday/nr};
                   value weekday/nr;
                   disabled python:day and day.weekday() == weekday['nr'];
                   checked python:
                      (day and day.weekday() ==  weekday['nr']
                       or (view.weekdays_widget.value and
                           weekday['nr'] in view.weekdays_widget.value))"/>
        <label tal:attributes="for string:weekday_${weekday/nr}"
               tal:content="weekday/name" class="plain" />
      </span>
    </fieldset>
    <!-- monthly box -->
    <fieldset id="monthly_box" class="">
      <legend>Monthly</legend>
      <p id="monthly_par">This section only applies when the monthly
      recurrence is selected.</p>
      <div class="row">
        <input type="radio" name="monthly" value="monthday" id="monthly_m"
               tal:attributes="checked
                       python:view.monthly_widget.value == 'monthday'"/>
        <label for="monthly_m" class="plain">
          Day <span tal:replace="view/getMonthDay"/> of every month</label>
      </div>
      <div class="row">
        <input type="radio" name="monthly" value="weekday" id="monthly_w"
               tal:attributes="checked
                       python:view.monthly_widget.value == 'weekday'"/>
        <label for="monthly_w" class="plain">
          <span tal:replace="view/getWeekDay"/> of every month</label>
      </div>
      <div class="row" tal:condition="view/getLastWeekDay">
        <input type="radio" name="monthly" value="lastweekday" id="monthly_l"
               tal:attributes="checked
                       python:view.monthly_widget.value == 'lastweekday'"/>
        <label for="monthly_l" class="plain">
           <span tal:replace="view/getLastWeekDay"/> of every month</label>
      </div>
    </fieldset>
    <!-- Range selection -->
    <div class="row">
      <input type="radio" name="range" value="count" id="range_c"
             tal:attributes="checked
                             python:view.range_widget.value == 'count'"/>
      <label for="range_c" class="plain">Repeat</label>
      <input type="text" name="count" id="count" size="3"
             tal:attributes="value view/count_widget/raw_value" /> times.
      <div tal:replace="structure view/count_widget/_error_html" />
    </div>

    <div class="row">
      <input type="radio" name="range" value="until" id="range_u"
             tal:attributes="checked
                             python:view.range_widget.value == 'until'"/>
      <label for="range_u" class="plain">Repeat until</label>
      <input type="text" name="until" id="until"
             tal:attributes="value view/until_widget/raw_value"/>
      <div tal:replace="structure view/until_widget/_error_html" />
    </div>

    <div class="row">
      <input type="radio" name="range" value="forever" id="range_f"
             tal:attributes="checked
                             python:view.range_widget.value == 'forever'"/>
      <label for="range_f" class="plain">Repeat forever</label>
    </div>

    <div class="row" tal:replace="structure view/exceptions_widget" />

    <!--
    <div class="row" tal:replace="structure view/weekdays_widget" />
    <div class="row" tal:replace="structure view/monthly_widget" />
    -->
  </div>
</tal:block>

    <input type="hidden" name="date"
           tal:attributes="value view/date" />

    <div class="buttons">
      <input class="button" name="SUBMIT" type="submit" value="Save"
             i18n:attributes="value" />
    </div>

  </form>
</tal:block>
</metal:block>
</body>
</html>
