<tal:defs define="ignored_status view/update" />
<html metal:use-macro="view/@@schooltool_macros/calendar/page" 
      i18n:domain="schoolbell">
<metal:block fill-slot="calendar-body">

<div id="events-allday">
  <tal:loop repeat="ev view/getAllDayEvents">
    <div class="event-allday"
         tal:attributes="style string:border: 1px ${ev/color2} solid;;
                         background: ${ev/color1};;">
      <h6>
        <a tal:attributes="href ev/viewLink"
           tal:omit-tag="not:ev/viewLink"
           tal:content="ev/title">(title)</a>
      </h6>
      <metal:block use-macro="template/macros/event-delete-button" />

      <p tal:condition="ev/description"
         tal:content="ev/description">
        (description)
      </p>
    </div>
  </tal:loop>
</div>

<div id="calendar-view-day"
     tal:define="hours python:list(view.getHours());
                 dayheight python: sum(h['height'] for h in hours);"
     tal:attributes="style string:height: ${dayheight}em">

<!-- Day grid -->
<tal:each_row repeat="hour hours">
    <div class="hour"
         tal:condition="view/canAddEvents"
         tal:attributes="onclick string:parent.location='${context/@@absolute_url}/add.html?field.start_date=${view/cursor}&amp;field.start_time=${hour/time}&amp;field.duration=${hour/duration}';
                         style string:top: ${hour/top}em;; height: ${hour/height}em;; cursor: pointer;
                         class string:hour ${repeat/hour/parity}">
      <a class="event-new" style="width:100%; height:100%;"
         i18n:attributes="title"
         tal:attributes="href string:${context/@@absolute_url}/add.html?field.start_date=${view/cursor}&amp;field.start_time=${hour/time}&amp;field.duration=${hour/duration};
                         title string:Add new event starting at ${hour/title}"
         tal:content="hour/title">HH:MM</a>
    </div>
    <div class="hour"
         tal:condition="not:view/canAddEvents"
         tal:attributes="style string:top: ${hour/top}em;; height: ${hour/height}em;
                         class string:hour ${repeat/hour/parity}">
      <span class="event-new" style="width:100%; height:100%;" title=""
         i18n:attributes="title"
         tal:content="hour/title">HH:MM</span>
    </div>
</tal:each_row>

<!-- Events -->
<div class="events" tal:define="compress python:view.getColumns() > 2">
  <tal:each_row repeat="hour hours">
    <tal:each_column repeat="ev hour/cols">
      <tal:if_have_an_event condition="ev">
        <div class="event"
             onmouseover="this.style.zIndex=9; this.style.overflow='visible'; this.style.display='block';"
             onmouseout="this.style.zIndex=1; this.style.overflow='hidden'; this.style.display='block';"
             tal:define="num repeat/ev/index;
                         unit python:compress and '%' or 'em';
                         indent python:compress and 15 or 20.5;
                         left python:num * indent;
                         top python:view.eventTop(ev);
                         height python:view.eventHeight(ev)"
             tal:attributes="style string:background: ${ev/color1};;
                             min-height: ${height}em;;
                             height: ${height}em;;
                             margin-left: $left$unit;;
                             top: ${top}em">
          <metal:block use-macro="template/macros/event-title-bar" />
          <metal:block use-macro="template/macros/event-delete-button" />

          <tal:block replace="structure provider:schooltool.CalendarEvent" />
        </div>
      </tal:if_have_an_event>
    </tal:each_column>
  </tal:each_row>
</div>

</div>
</metal:block>
</html>

<tal:hide-macro-definitions-from-browser condition="nothing">

<!-- Macro for the title bar of an event box.
     Expects to find an EventForDisplay instance named 'ev'
  -->
<metal:block define-macro="event-title-bar">
  <h6 tal:attributes="style string:background: ${ev/color2}">
    <a tal:attributes="href ev/viewLink; title ev/title"
       tal:omit-tag="not:ev/viewLink">
      <span tal:replace="ev/shortTitle">(shortened title)</span>
      <span class="start-end"
            tal:define="start python:ev.dtstarttz.strftime(view.time_fmt);
                        end python:ev.dtendtz.strftime(view.time_fmt)">
        (<span tal:content="start">HH:MM</span>
          - <span tal:content="end">HH:MM</span>)
      </span>
    </a>
  </h6>
</metal:block>

<!-- Macro for the delete button in an event box.
     Expects to find an EventForDisplay instance named 'ev'

     XXX mg: I suspect that
               i18n:attributes="title"
               tal:attributes="title string:Delete $foo"
             will not work, as it might try to translate all the real titles
             (such as "Delete Meeting With Friend"), which will never be
             defined in the '.po' file.
  -->
<metal:block define-macro="event-delete-button">
  <tal:if_can_remove_events condition="view/canRemoveEvents">
    <a class="delete"
       tal:condition="ev/deleteLink"
       tal:attributes="href ev/deleteLink;
                       title string:Delete ${ev/title}"
       i18n:attributes="title"
      ><img alt="[X]" tal:attributes="src context/++resource++delete.png"
            /></a>
  </tal:if_can_remove_events>
</metal:block>

</tal:hide-macro-definitions-from-browser>
