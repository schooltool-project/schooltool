<configure
    xmlns="http://namespaces.zope.org/zope"
    xmlns:security="http://schooltool.org/securitypolicy"
    xmlns:wfmc="http://namespaces.zope.org/wfmc"
    >

  <!-- Process Definition for Promotion workflow -->
  <wfmc:xpdl
      file="promotion.xpdl"
      process="promotion"
      id="schooltool.promotion"
      integration="zope.wfmc.adapter.integration"
      />

  <!-- Participant: Manager -->
  <adapter
     for="zope.wfmc.interfaces.IActivity"
     provides="zope.wfmc.interfaces.IParticipant"
     factory=".promotion.Manager"
     name=".manager"
     />

  <!-- Promotion Workflow subscribers -->
  <subscriber
      for="zope.wfmc.interfaces.IProcessStarted"
      handler=".promotion.addProcessToStudent"
      />

  <subscriber
      for="zope.wfmc.interfaces.IProcessFinished"
      handler=".promotion.removeProcessFromStudent"
      />

  <!-- Workflow Applications -->
  <!-- Note: The names start with a dot, because they are defined in the
             pacakge not the process. We might want to change that later. -->

  <!-- Progress to Next Level (level : input/output)  -->
  <adapter
      for="zope.wfmc.interfaces.IParticipant"
      provides="zope.wfmc.interfaces.IWorkItem"
      factory=".promotion.ProgressToNextLevel"
      name=".progressToNextLevel"
      />

  <!-- Select Initial Level (level : output)  -->
  <adapter
      for="zope.wfmc.interfaces.IParticipant"
      provides="zope.wfmc.interfaces.IWorkItem"
      factory=".promotion.SelectInitialLevel"
      name=".selectInitialLevel"
      />

  <!-- Set Level Outcome (outcome : output)  -->
  <adapter
      for="zope.wfmc.interfaces.IParticipant"
      provides="zope.wfmc.interfaces.IWorkItem"
      factory=".promotion.SetLevelOutcome"
      name=".setLevelOutcome"
      />

  <!-- Update Status (student : input)  -->
  <adapter
      for="zope.wfmc.interfaces.IParticipant"
      provides="zope.wfmc.interfaces.IWorkItem"
      factory=".promotion.UpdateStatus"
      name=".updateStatus"
      />

  <!-- Write Record (student : input, level: input)  -->
  <adapter
      for="zope.wfmc.interfaces.IParticipant"
      provides="zope.wfmc.interfaces.IWorkItem"
      factory=".promotion.WriteRecord"
      name=".writeRecord"
      />

  <!-- Group to Work Items List Adapater -->
  <adapter
      for="schooltool.group.interfaces.IGroup"
      provides=".interfaces.IManagerWorkItems"
      factory=".promotion.getManagerWorkItems"
      />


  <!-- Application objects -->

  <interface
      interface=".interfaces.ILevelContainer"
      type="zope.app.content.interfaces.IContentType"
      />

  <class class=".level.LevelContainer">
    <implements
        interface="zope.annotation.interfaces.IAttributeAnnotatable" />
    <allow interface="zope.app.container.interfaces.ISimpleReadContainer" />
    <require permission="schooltool.view"
             attributes="keys values items __iter__ __len__ validate" />
    <require permission="schooltool.edit"
             interface="zope.app.container.interfaces.IWriteContainer" />
  </class>

  <interface
      interface=".interfaces.ILevel"
      type="zope.app.content.interfaces.IContentType"
      />

  <class class=".level.Level">
    <implements
        interface="zope.annotation.interfaces.IAttributeAnnotatable" />
    <require permission="schooltool.view"
             interface=".interfaces.ILevel" />
    <require permission="schooltool.edit"
             set_schema=".interfaces.ILevel" />
  </class>

  <!-- Application hook -->
  <subscriber
      for="schooltool.app.interfaces.IApplicationInitializationEvent"
      handler=".level.addLevelContainerToApplication"
      />


  <!-- Level vocabulary -->
  <utility
      provides="zope.schema.interfaces.IVocabularyFactory"
      component="schooltool.level.level.LevelVocabulary"
      name="Levels"
      />

  <!-- Academic Record Adapter -->
  <class class=".record.History">
    <allow interface="zope.interface.common.sequence.IReadSequence" />
    <require permission="schooltool.edit"
             interface="zope.interface.common.sequence.IWriteSequence"
             attributes="addRecord" />
  </class>

  <class class=".record.HistoricalRecord">
    <require permission="schooltool.view"
             interface=".interfaces.IHistoricalRecord" />
  </class>

  <class class=".record.AcademicRecord">
    <require permission="schooltool.view"
             interface=".interfaces.IAcademicRecord" />
    <require permission="schooltool.edit"
             set_schema=".interfaces.IAcademicRecord" />
  </class>

  <adapter
      for="schooltool.person.interfaces.IPerson"
      provides=".interfaces.IAcademicRecord"
      factory=".record.AcademicRecord"
      trusted="true"
      locate="true"
      />

  <!-- sample data -->
  <configure
      xmlns:zcml="http://namespaces.zope.org/zcml"
      zcml:condition="have devmode">

    <utility
        factory=".sampledata.SampleLevels"
        provides="schooltool.sampledata.interfaces.ISampleDataPlugin"
        name="levels"
        />

  </configure>

  <!-- Views -->
  <include package=".browser" />
  <include package=".rest" />

  <security:allow
      interface="schooltool.level.level.LevelContainer"
      crowds="administration everybody"
      permission="schooltool.view" />
  <security:allow
      interface="schooltool.level.level.LevelContainer"
      crowds="administration"
      permission="schooltool.edit" />

</configure>
