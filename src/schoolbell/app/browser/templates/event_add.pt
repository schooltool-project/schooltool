<tal:defs define="dummy view/update" />
<html metal:use-macro="view/@@standard_macros/page" i18n:domain="schooltool">
<head>
  <title metal:fill-slot="title" i18n:translate=""
         tal:content="view/title">Add/edit event</title>
  <script type="text/javascript" metal:fill-slot="extrahead">
    function recurrence_changed() {
        var recurrence = document.getElementById('field.recurrence');
        var recurrence_box = document.getElementById('recurrence_box');
        var update_box = document.getElementById('update_box');
        if (recurrence.checked) {
            recurrence_box.style.display = 'block';
            update_box.style.display = 'block';
        } else {
            recurrence_box.style.display = 'none';
            update_box.style.display = 'none';
        }
    }
    function recurrence_type_changed() {
        form = document.getElementById('form');
        var recurrence = document.getElementById('field.recurrence_type');
        var weekly_row = document.getElementById('weekly_row');
        var monthly_box = document.getElementById('monthly_box');
        if (recurrence.value == 'weekly') {
            weekly_row.style.display = 'block';
            monthly_box.style.display = 'none';
        } else if (recurrence.value == 'monthly') {
            weekly_row.style.display = 'none';
            monthly_box.style.display = 'block';
        } else {
            weekly_row.style.display = 'none';
            monthly_box.style.display = 'none';
        }
    }
    function range_changed() {
        var range_c = document.getElementById('field.range_c');
        var range_u = document.getElementById('field.range_u');
        var count = document.getElementById('field.count');
        var until = document.getElementById('field.until');
        count.disabled = !range_c.checked;
        until.disabled = !range_u.checked;
    }
    function onloadhook() {
        if (!document.getElementById('recurrence_box'))
            return;

        recurrence_changed();
        var recurrence = document.getElementById('field.recurrence');
        addEvent(recurrence, "click", recurrence_changed);

        range_changed();
        var range_c = document.getElementById('field.range_c');
        var range_u = document.getElementById('field.range_u');
        var range_f = document.getElementById('field.range_f');
        addEvent(range_c, "click", range_changed);
        addEvent(range_u, "click", range_changed);
        addEvent(range_f, "click", range_changed);

        recurrence_type_changed();
        form = document.getElementById('form');
        var recurrence_type = form['field.recurrence_type'];
        addEvent(recurrence_type, "change", recurrence_type_changed);
        addEvent(recurrence_type, "keyup", recurrence_type_changed);

        /* Hide the help paragraphs if JavaScript is working */
        var weekly_par = document.getElementById('weekly_par');
        var monthly_par = document.getElementById('monthly_par');
        monthly_par.style.display = 'none';
        weekly_par.style.display = 'none';
    }
    function addEvent(obj, event, handler) {
      if (obj.addEventListener) {
          obj.addEventListener(event, handler, false);
      } else if (obj.attachEvent) {
          obj.attachEvent("on" + event, handler);
      }
    }
    addEvent(window, "load", onloadhook);
  </script>
</head>
<body>
<metal:nothing metal:fill-slot="content-header" />

<metal:block metal:fill-slot="body">
  <form id="form" class="standalone" method="POST" enctype="multipart/form-data"
        tal:attributes="action request/URL">
    <h3 i18n:translate="">Event information</h3>

    <div class="error" tal:condition="view/error" tal:content="view/error" />
    <input tal:condition="view/_redirectToDate"
           tal:attributes="value view/_redirectToDate"
           type="hidden" name="date"/>

    <fieldset>
      <legend i18n:translate="">Event details</legend>

      <div class="row" tal:define="widget nocall:view/title_widget">
        <div metal:use-macro="context/@@form_macros/widget_row" />
      </div>
      <div class="row" tal:define="widget nocall:view/start_date_widget">
        <div metal:use-macro="context/@@form_macros/widget_row" />
      </div>
      <div class="row" tal:define="widget nocall:view/start_time_widget">
        <div metal:use-macro="context/@@form_macros/widget_row" />
      </div>
      <div class="row" tal:define="widget nocall:view/duration_widget">
        <div metal:use-macro="context/@@standard_macros/widget_row_with_extra">
          <metal:block fill-slot="extra" i18n:translate="">minutes</metal:block>
        </div>
      </div>
      <div class="row" tal:define="widget nocall:view/location_widget">
        <div metal:use-macro="context/@@form_macros/widget_row" />
      </div>
      <div class="row" tal:define="widget nocall:view/description_widget">
        <div metal:use-macro="context/@@form_macros/widget_row" />
      </div>

      <div class="row" tal:define="widget nocall:view/recurrence_widget">
        <div metal:use-macro="context/@@standard_macros/checkbox_widget " />
      </div>

      <div id="recurrence_box">
        <div class="controls" id="update_box">
          <input class="button-ok" name="UPDATE" type="submit"
            value="Update form" i18n:attributes="value" />
        </div>
        <!-- Repeat every [count] [freq [v]] -->
        <div class="row">
          <div class="row" tal:define="widget nocall:view/interval_widget">
            <div metal:use-macro="context/@@standard_macros/widget_row_with_extra">
              <metal:block fill-slot="extra">
              <tal:comment condition="nothing">
              Sadly, the Zope 3 SelectWidget is brain-dead:
                - no "id" attribute on the select element
                - renders two divs for no reason
              TODO: follow it up in Zope 3.
              </tal:comment>
              <select name="field.recurrence_type" size="1"
                      id="field.recurrence_type">
              <option selected="selected" value="daily">day</option>
              <option value="weekly">week</option>
              <option value="monthly">month</option>
              <option value="yearly">year</option>
              </select>
              </metal:block>
            </div>
          </div>
        </div>
        <!-- weekly box -->
        <fieldset id="weekly_row">
          <legend i18n:translate="">Weekly</legend>
          <p id="weekly_par" i18n:translate="">
            This section only applies when weekly recurrence is selected.
          </p>
          <span tal:repeat="term view/weekdays_widget/vocabulary">
            <input name="field.weekdays-empty-marker" type="hidden" value="1" />
            <input type="checkbox" name="field.weekdays:list"
                   tal:attributes="
                   id string:weekday_${term/token};
                   value term/token;
                   disabled python:view.weekdayDisabled(term.token);
                   checked python:view.weekdayChecked(term.token)"
                   />
            <label tal:attributes="for string:weekday_${term/token}"
               tal:content="python:view.weekdays_widget.textForValue(term)" class="plain" />
          </span>
        </fieldset>
        <!-- monthly box -->
        <fieldset id="monthly_box" class=""
                  tal:define="monthly_value python:view.monthly_widget._getFormValue()">
          <legend i18n:translate="">Monthly</legend>
          <p id="monthly_par" i18n:translate="">
            This section only applies when the monthly recurrence is selected.
          </p>
          <div class="row">
            <input type="radio" name="field.monthly" value="monthday" id="monthly_m"
              tal:attributes="checked python:monthly_value == 'monthday'"/>
            <label for="monthly_m" class="plain" i18n:translate="">
              Day <span tal:replace="view/getMonthDay" i18n:name="monthday"/> of
              every month</label>
          </div>
          <div class="row">
            <input type="radio" name="field.monthly" value="weekday" id="monthly_w"
              tal:attributes="checked python:monthly_value == 'weekday'"/>
            <label for="monthly_w" class="plain" i18n:translate="">
              <span tal:replace="view/getWeekDay" i18n:name="weekday" /> of
              every month</label>
          </div>
          <div class="row" tal:condition="view/getLastWeekDay">
            <input type="radio" name="field.monthly" value="lastweekday" id="monthly_l"
              tal:attributes="checked python:monthly_value == 'lastweekday'"/>
            <label for="monthly_l" class="plain" i18n:translate="">
              <span tal:replace="view/getLastWeekDay" i18n:name="" /> of
              every month</label>
          </div>
        </fieldset>
        <!-- Range selection -->
        <fieldset tal:define="range_value
                  python:view.range_widget.hasInput() and view.range_widget.getInputValue() or 'forever'">
          <div class="row">
            <input type="radio" name="field.range" value="count" id="field.range_c"
                   tal:attributes="checked python:range_value == 'count'"/>
            <label for="field.range_c" class="plain" i18n:translate="">Repeat</label>
            <input type="text" name="field.count" id="field.count" size="3"
                   tal:attributes="value view/count_widget/_getFormInput" />
            <tal:block i18n:translate="">times</tal:block>
            <tal:block tal:define="widget nocall:view/count_widget">
              <div class="error" tal:define="error widget/error"
                   tal:condition="error" tal:content="structure error">
                The Error
              </div>
            </tal:block>
          </div>

          <div class="row">
            <input type="radio" name="field.range" value="until" id="field.range_u"
                   tal:attributes="checked python:range_value == 'until'"/>
            <label for="field.range_u" class="plain" i18n:translate="">Repeat until</label>
            <input type="text" name="field.until" id="field.until"
                   tal:attributes="value view/until_widget/_getFormInput"/>
            <tal:block tal:define="widget nocall:view/until_widget">
              <div class="error" tal:define="error widget/error"
                   tal:condition="error" tal:content="structure error">
                The Error
              </div>
            </tal:block>
          </div>
          <div class="row">
            <input type="radio" name="field.range" value="forever" id="field.range_f"
                   tal:attributes="checked python:range_value == 'forever'"/>
            <label for="field.range_f" class="plain" i18n:translate="">
              Repeat forever</label>
          </div>
          <tal:block tal:define="widget nocall:view/range_widget">
            <div class="error" tal:define="error widget/error"
                 tal:condition="error" tal:content="structure error">
              The Error
            </div>
          </tal:block>
        </fieldset>
        <div class="row" tal:define="widget nocall:view/exceptions_widget">
          <div metal:use-macro="context/@@form_macros/widget_row" />
        </div>
      </div>
    </fieldset>
    <div class="controls">
      <input type="submit" class="button-ok" name="UPDATE_SUBMIT"
             tal:attributes="value view/submit_button_title"
             title="Shortcut: Alt-A" accesskey="A"
             i18n:attributes="accesskey" />
      <input type="submit" class="button-cancel" name="CANCEL" value="Cancel"
             i18n:attributes="value cancel-button" />
    </div>
  </form>
</metal:block>
</html>
