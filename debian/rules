#!/usr/bin/make -f

# If you change the seed, you will have to recreate ttconfig.data as well.
datagen_seed = schooltool-m4

libpkg=libschooltool-server
package=schooltool-server
common=$(package)
packageclients=schooltool-clients
libpkgclients=libschooltool-clients


build: build-stamp

build-stamp:
	dh_testdir
	$(MAKE)
	(cat debian/import-sampleschool.head && \
	 sed -ne '/^# -- Do not remove this line --$$/,$$p' \
	     import-sampleschool.py) > debian/import-sampleschool
	chmod 755 debian/import-sampleschool
	touch build-stamp

debdirclean:
	#This rule is only meant to be called from the top level makefile
	rm -rf debian/schooltool-server debian/schooltool-clients
	rm -f debian/schooltool-clients.substvars
	rm -f debian/schooltool-clients.postinst.debhelper
	rm -f debian/schooltool-clients.prerm.debhelper
	rm -f debian/schooltool-server.substvars
	rm -f debian/schooltool-server.postinst.debhelper
	rm -f debian/schooltool-server.postrm.debhelper
	rm -f debian/schooltool-server.prerm.debhelper
	rm -f debian/import-sampleschool
	rm -f debian/files

clean::
	dh_testdir
	dh_testroot
	rm -f build-stamp install-stamp debian/import-sampleschool
	-$(MAKE) realclean
	dh_clean

install: install-stamp

install-stamp: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs
	#make server libary
	# what about ZConfig/doc/schema.dtd? zconfig.pdf?
	cd src && \
	find \( -name tests -o -name ftests -o -name clients \) -prune -o \
	     \( -name '*.so' \) \
	     -exec install -m 644 -D -p {} \
		../debian/$(libpkg)/usr/lib/$(libpkg)/{} \;
	#make common
	# move directories with architecture independent files into usr/share
	cd src && \
	find \( -name tests -o -name ftests -o -name clients \) -prune -o \
	     \( -name '*.py'  -o -name '*.pt' -o \
	        -name '*.xml' -o -name '*.rng' -o -name '*.png' -o \
		-name '*.xpm' -o -name '*.css' \) \
	     -exec install -m 644 -D -p {} \
		../debian/$(common)/usr/share/$(common)/{} \;
	
	# make symlinks from .so files to /usr/share
	cd debian/$(libpkg)/usr && \
	find lib -iname '*.so' | \
	    while read w; do\
		tmp=`echo $$w | sed s/$(libpkg)/$(common)/`;\
		tmp2=`dirname ../../$(common)/usr/share$${tmp:3}`;\
		install -m 755 -d $$tmp2;\
		cd $$tmp2;\
		ln -s `echo $${w:4}|sed s/[^/]*/../g`/$$w;\
		cd - ;\
	    done
	
	rm -f debian/$(common)/usr/share/$(common)/trace.py
	# Make client libary
	cd src && \
	find zope/interface schooltool/clients \
	    \( -name tests -o -name ftests \) -prune -o \
	     \( -name '*.so' \) \
	     -exec install -m 644 -D -p {} \
		../debian/$(libpkgclients)/usr/lib/$(libpkgclients)/{} \;
	
	cd src && \
	find zope/interface schooltool/clients \
	     \( -name 'tests' -o -name 'ftests' \) -prune -o\
	     \( -name '*.py' -o -name '*.pt' -o -name '*.xml' \
	        -o -name '*.rng' -o -name '*.png' -o -name '*.xpm' \) \
	     -exec install -m 644 -D -p {} \
		../debian/$(packageclients)/usr/share/$(packageclients)/{} \;
	for fn in schooltool/__init__.py \
	          schooltool/common.py \
	          schooltool/csvimport.py \
	          schooltool/interfaces.py \
	          schooltool/unchanged.py \
	          schooltool/uris.py \
	          schooltool/translation/__init__.py \
	          zope/__init__.py; \
	do \
	    install -m 644 -D -p src/$$fn \
		debian/schooltool-clients/usr/share/schooltool-clients/$$fn; \
	done

	# make symlinks from .so files to /usr/share for clients
	cd debian/$(libpkgclients)/usr && \
	find lib -iname '*.so' | \
	    while read w; do\
		tmp=`echo $$w | sed s/$(libpkgclients)/$(packageclients)/`;\
		tmp2=`dirname ../../$(packageclients)/usr/share$${tmp:3}`;\
		install -m 755 -d $$tmp2;\
		cd $$tmp2;\
		ln -s `echo $${w:4}|sed s/[^/]*/../g`/$$w;\
		cd - ;\
	    done
	
	install -m 755 -D -p debian/schooltool-server.py \
		debian/$(common)/usr/bin/schooltool-server; \
	install -m 644 -D -p debian/schooltool.logrotate \
		debian/$(common)/etc/logrotate.d/schooltool
	
	for p in schooltool-client wxschooltool import-sampleschool; do \
	    install -m 755 -D -p debian/$$p \
		    debian/schooltool-clients/usr/bin/$$p; \
	done

	install -m 644 -D -p debian/schooltool.conf \
	    debian/schooltool-server/etc/schooltool.conf

	install -m 644 -D -p ttconfig.data \
	    debian/schooltool-clients/usr/share/schooltool-clients/sampleschool/ttconfig.data

	dir=$$PWD \
	    && cd debian/schooltool-clients/usr/share/schooltool-clients/sampleschool/ \
	    && PYTHONPATH=$$dir/src \
	       python $$dir/src/schooltool/clients/datagen.py $(datagen_seed)

	touch install-stamp

binary-indep: build install

binary-arch: build install
	dh_testdir
	dh_testroot
	dh_installdocs
	dh_installinit --name=schooltool
	dh_installexamples
	dh_installman
	dh_installchangelogs
	dh_strip
	dh_compress
	dh_fixperms
	dh_python
	dh_makeshlibs
	dh_installdeb
	dh_shlibdeps	
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary: binary-arch binary-indep

.PHONY: build clean binary-indep binary-arch binary install
